<?php
//ini_set('display_errors', 1);
//ini_set('display_startup_errors', 1);
//error_reporting(E_ALL);
$DEBUG_MODE=0;
//THIS FILE IS ONLY FOR STUDENTS
include("security/header.php");
if(!$hay_sesion )Header("Location:login.htm");
$con=openDB();
$LESSONFOUND=0;
$form_lessoncode=$_POST['form_lessoncode'];  //first time this will be empty
$form_lessontype=$_POST['form_lessontype'];  //first time this will be empty
$form_lessonsubject=$_POST['form_lessonsubject'];  //first time this will be empty
$form_requestlesson=$_POST['form_requestlesson'];  //first time this will be empty

$form_paysection=$_POST['form_paysection']; //MAE

$form_field=$_POST['form_field'];//first time this will be empty

$form_availabletutor = $_POST['form_availabletutor'];  		// MAE. 09/06/2020 Campo de código para tutor disponible.
$form_level = $_POST['form_level'];							// MAE. 09/06/2020 Campo de nivel del estudiante Beginner / Advanced.

$form_availableminutes = $_POST['form_availableminutes'];	// MAE. 09/06/2020 Campo de Avaliable minutes.
$form_addcredit = $_POST['form_addcredit'];

$form_rate=$_POST['form_rate'];//first time this will be empty
$form_attach_document=$_POST['form_attach_document'];//first time this will be empty
$form_problem_comments=$_POST['form_problem_comments'];//first time this will be empty
$form_estimated_time=$_POST['form_estimated_time'];//first time this will be empty
$form_due_date=$_POST['form_due_date'];//first time this will be empty
$form_availability_option1=$_POST['form_availability_option1'];//first time this will be empty
$form_availability_option2=$_POST['form_availability_option2'];//first time this will be empty

$_selected_lesson_type = 1;// DEFAULT LESSON TYPE: instant lesson
$SECONDS_SINCE_REQUEST = 1;
if($form_lessontype=='')$form_lessontype=0;
if($form_lessonsubject=='')$form_lessonsubject=0;
if($form_requestlesson=="")$form_requestlesson="no";

if($form_paysection=="")$form_paysection="no"; //MAE

include 'lesson.req.php';

if($USER_TYPE!="STUDENT") exit(); //this file only for students

//NOTE: WE ONLY HAVE 4 SESSION VARIABLES

    //FIRST CHECK IF THERE ARE PAST LESSONREQUEST IN STATUS = 1 THAT I NEVER ENTERED (STATUS=1 AND TIME>MAXWAITINGTIME THEN STATUS=4)	 
	//WITH THIS IT SHOULD BE MAXIMUM ONE LESSON WITH STOPPED=0 
	$query="UPDATE LESSONREQUESTS2 SET STATUS=4 WHERE USERCODE='$USER_CODE' AND STATUS=1 AND TIME_TO_SEC(TIMEDIFF(NOW(),TUTORTIME))>$MAXWAITINGTIME"; 
	$resultado=genesis_exec($con,$query);
		
	
   //SECOND CHECK IF THERE ARE PAST LESSONREQUEST IN STATUS = 2 THAT I NEVER TERMINATED (STATUS=2 AND TIME>MAXINACTIVETIME THEN STATUS=3)

    //IF IT IS ME WHO DID LEAVE THE LESSON I JUST CLOSE THE LESSON, IF IT WAS TUTOR AND I AM STILL IN THE LESSON THEN THERE WILL BE A MESSAGE INSIDE THE LESSON (lessonwindowheader)
    $query="UPDATE LESSONREQUESTS2 SET STATUS=3 WHERE USERCODE='$USER_CODE' AND STATUS=2 AND TIME_TO_SEC(TIMEDIFF(NOW(),LASTUPDATESTUDENT))>$MAXINACTIVETIME"; 
	$resultado=genesis_exec($con,$query);
	
 
 	// addcredit
	function addcredit($conn, $charge, $minutes, $ratefor, $usercode)
	{
		$query="INSERT INTO PAYMENTS (USERCODE,DATE,MINUTES,RATEFOR30,CHARGE) VALUES ($usercode,NOW(),$minutes,$ratefor, $charge)";
		$resultado = genesis_exec($conn,$query);
		$query="UPDATE USERS2 SET BALANCE=BALANCE+$charge WHERE USERCODE=$usercode";
		$resultado=genesis_exec($conn,$query);
		$message="";
	}
	
	if(array_key_exists('paybutton',$_POST)){
		
		$form_tariffturor = $_POST['form_tariffturor'];
		$form_minutes = $form_addcredit / $form_tariffturor * 60;
		$ratefor = 60 / $form_tariffturor;
				
		addcredit($con, $form_addcredit, $form_minutes, $ratefor, $USER_CODE);
		
		$form_availableminutes = ($BALANCE + $form_addcredit) / $form_tariffturor * 60;
	}
 
 
    //NOW STATUS TRANSITIONS	
    if($form_requestlesson=="yes")  //in case we reload the page it is going to be on hold and it will not insert the tables again   
	{
	    //validate there is no active lesson
		//ANY TIME THERE MUST BE ONLY ONE ACTIVE REQUEST (STATUS=0 OR 1) OR IN PROGRESS (STATUS=2)
		if ($DEBUG_MODE)echo "2";
		$query="SELECT * FROM LESSONREQUESTS2 WHERE USERCODE='$USER_CODE' AND STATUS IN (0,1,2)";
		$resultado=genesis_exec($con,$query);
		if(!genesis_fetch_row($resultado))
        {		
			$school=$_SESSION['SCHOOLTYPE'];
			
			//MAE. 09/06/2020 agregamos campo TUTOR Y NIVEL o LEVELSTUDENT
			$query="INSERT INTO LESSONREQUESTS2 (USERCODE,REQUESTTIME,SCHOOLTYPE,FIELD,LESSONSUBJECT,LESSONTYPE,TUTOR,LEVELSTUDENT)
					VALUES('$USER_CODE',NOW(),$school,$form_field,$form_lessonsubject,$form_lessontype, $form_availabletutor,$form_level)";
			$resultado=genesis_exec($con,$query);
			$form_requestlesson="hold";
                        
			$fmcQuery = "SELECT LAST_INSERT_ID() as insert_id FROM LESSONREQUESTS2";
			$fmcResults = genesis_exec($con, $fmcQuery);
			$_row = genesis_fetch_row($fmcResults);                                                
			if ($_row){
				$fmcLastInsertId = genesis_result($fmcResults, 1);                            
				$form_attach_document = uploadAttachDocument($USER_CODE, $fmcLastInsertId);
				updateLessonRequest($con, $fmcLastInsertId, $form_rate
						,$form_attach_document, $form_problem_comments, $form_estimated_time
						,$form_due_date,$form_availability_option1,$form_availability_option2);
			}
                        
		}
		else
		{
			//already a pending request we can not add new one
			echo "We can not add a new request, there is already a pending request";
			$form_requestlesson="hold";
		}		
	}
	if($form_requestlesson=="cancel")  //in case we reload the page it is going to be on hold and it will not insert the tables again   
	{
	    if ($DEBUG_MODE)echo "3";
		//WE CAN ONLY CANCEL IF THE LESSON DID NOT START YET
		//AT ANY TIME THERE IS ONLY ONE ACTIVE LESSON REQUEST IN STATUS =0,1 OR 2
		$query="UPDATE LESSONREQUESTS2 SET STATUS=4 WHERE USERCODE='$USER_CODE' AND (STATUS=0 OR STATUS=1)";
		$resultado=genesis_exec($con,$query);
		$form_requestlesson="no";					
	}
	
	
	$LESSON_CODEVAR='';
	$STATUS=-1;
	//if($STATUS==0)echo "status=0";
	$DEADLINE=0;
	if($form_requestlesson=="hold" || $form_requestlesson=="no")      //we check if a tutor accepted or if there is pending request
	{
	    if ($DEBUG_MODE)echo "4";
		//SEE CONSTANTS FILES TO SEE THE STATUS 
		//ONLY ACTIVE REQUEST
		//ANY TIME THERE MUST BE ONLY ONE ACTIVE REQUEST (STATUS=0 OR 1) OR IN PROGRESS (STATUS=2)
		
		//MAE. 09/06/2020  Se agregó el campo TUTOR y LEVELSTUDENT.
		$query="SELECT FIELD,LESSONSUBJECT,LESSONTYPE,STATUS,SCHOOLTYPE,LESSONCODE,time_to_sec(concat('00:',substr(TUTORTIME,15,5))),TIME_TO_SEC(TIMEDIFF(NOW(), REQUESTTIME)) as SECONDS_SINCE_REQUEST, TUTOR, LEVELSTUDENT
		FROM LESSONREQUESTS2 WHERE USERCODE='$USER_CODE' AND STATUS IN (0,1,2) ";
		//looks for requests that are either new(0) tutor assigned(1) or lesson in progress (2)
		//IF STATUS ==0 THEN IT JUST USES THE DATA OF THE REQUESTS
		//IF STATUS==1 THEN IT COMMUNICATES THE STUDENT TO ENTER THE LESSON
		//IF STATUS==2 AND MYLESSONWINDOWCLOSED THEN IT TELLS THE STUDENT TO GO BACK TO LESSON
		$resultado=genesis_exec($con,$query);
		if(genesis_fetch_row($resultado))
		{
			$form_field=genesis_result($resultado,1);
			$form_lessonsubject=genesis_result($resultado,2);
			$form_lessontype=genesis_result($resultado,3);
			$STATUS=genesis_result($resultado,4);
			$form_schooltype=genesis_result($resultado,5);
			$SECONDS_SINCE_REQUEST = genesis_result($resultado, 8);
			$TUTORLESSON_USERCODE = genesis_result($resultado, 9);  //MAE. 09/06/2020 Recuperar el código del tutor
			$form_level = genesis_result($resultado, 10);  //MAE. 09/06/2020 Recuperar el nivel del estudiante
		  
		}
		//also we need to validate that there are not other active or in progress (active status<>3 and <>4) request before inserting a new request 
		
		if($STATUS==1)  //TUTOR HAS ACCEPTED
		{
			if ($DEBUG_MODE)echo "4.1";
			$LESSON_CODEVAR=genesis_result($resultado,6);
			$TUTORTIME=genesis_result($resultado,7);
			$DEADLINE=$TUTORTIME+$MAXWAITINGTIME;	//only seconds regardless of date		
			$LESSONFOUND=1;			
		}		
		$form_requestlesson=="hold";  //WE KEEP IT IN THIS STATE 
	}
	
	
	
	/* IF WE WANT TO SHOW A MESSAGE TELLING THE STUDENT THAT TUTOR CANCELLED THE REQUEST WE WILL NEEED TO SAVE THE LESSONREQUEST AT THE TIME OF SUBMITTING THE REQUEST
	// ( SAVING IT IN form or session varible ) AND THEN LOOK AT THE TABLE FOR THAT REQUEST AND IF IT IS ON STATUS==4 THEN WE SHOW A MESSAGE
    //	PROBABLY MORE CLEAR, EFFICIENT AND STRAIGTH FORWARD IS TO SHOW A COUNTDOWN TIMER WHEN TUTOR IS FOUND SO STUDENT KNOW HE HAS LIMITED TIME 
	if($form_requestlesson=="hold")  //we check if the tutor left the lesson     
	{
	    if ($DEBUG_MODE)echo "5";
		$query="SELECT * FROM LESSONREQUESTS2 WHERE USERCODE='$USER_CODE' AND LESSONCODE=$LESSON_CODEVAR AND STATUS=4 "; //cancelled
		$res=genesis_exec($con,$query);
		if(genesis_fetch_row($res))  //TUTOR HAS ACCEPTED then student did not enter on time so tutor left
		{
			if ($DEBUG_MODE)echo "5.1";
			$STATUS=4;
			$LESSON_CODEVAR="";
			$LESSONFOUND=0; 
			$form_requestlesson=="no";			
		}		   
	}*/	

if($form_field!='') //second time (page reloaded)
{
    if ($DEBUG_MODE)echo "8";

	if($form_schooltype!="")$SCHOOLTYPE=$form_schooltype;
	$query="SELECT SUBJECTCODE,DESCRIPTION FROM SUBJECTS WHERE FIELD=$form_field AND SCHOOLTYPE=$SCHOOLTYPE";
	$resultado=genesis_exec($con,$query);
	$i=0;
	while(genesis_fetch_row($resultado))
    { 	
		$SUBJECTS_CODES[$i]=genesis_result($resultado,1);
		$SUBJECTS_NAMES[$i]=genesis_result($resultado,2); 
		//echo($SUBJECTS_CODES[$i]);
		$i++;	
	}	
	$query="SELECT CODE,LESSONTYPE FROM LESSONTYPES WHERE FIELD=$form_field AND SCHOOLTYPE=$SCHOOLTYPE AND ACTIVE = 1";
	$resultado=genesis_exec($con,$query);
	$i=0;
	while(genesis_fetch_row($resultado))
    { 	
		$LESSONTYPES_CODES[$i]=genesis_result($resultado,1);
		$LESSONTYPES_NAMES[$i]=$LESSON_TYPE[genesis_result($resultado,2)]; 
		$LESSONTYPES_LESSONTYPE[$i]=genesis_result($resultado,2); 
                if ($form_lessontype!="" && $form_lessontype==$LESSONTYPES_CODES[$i]){
                    $_selected_lesson_type = $LESSONTYPES_LESSONTYPE[$i];
                }
		//Echo($LESSONTYPES_CODES[$i]);
		//echo($LESSONTYPES_NAMES[$i]);
		$i++;	
	}		
}

	//  MAE  08/06/2020 cargar tutor disponible para fiel y subject
	if($form_field!='') {
		$query="SELECT TS.USERCODE, CONCAT(US.NAME,' - $',US.TARIFF,'/hour') AS TARIFF 
				FROM TUTORS_SUBJECTS AS TS
				INNER JOIN USERS2 US ON TS.USERCODE = US.USERCODE
				WHERE US.ACTIVETUTOR = 1 AND US.USERTYPE='TUTOR'
				AND TS.FIELD = $form_field and TS.SUBJECT=$form_lessonsubject";
		$resultado=genesis_exec($con,$query);
		$i=0;
		while(genesis_fetch_row($resultado))
		{ 	
			$TUTORLESSON_USERCODE[$i]=genesis_result($resultado,1);
			$TUTORLESSON_TARIFF[$i]=genesis_result($resultado,2);
			$i++;	
		}
	}
	
//REMEMBER AT EACH TIME THERE IS ONLY ONE LESSON IN STATUS 0,1 OR 2	
//if the lesson already exists (lesson window opened) then we only enable the open button it it was closed
$query="SELECT TIME_TO_SEC(TIMEDIFF(NOW(),LASTUPDATESTUDENT))  FROM LESSONREQUESTS2 WHERE USERCODE='$USER_CODE' AND STATUS=2";
$resultado=genesis_exec($con,$query);
$MYLESSONWINDOWCLOSED=0; 
if(genesis_fetch_row($resultado)) 
{ 	
	$DIFF=genesis_result($resultado,1);
//echo "DIFF=$DIFF";
	if($DIFF>$RELOAD/1000)
	{
		$MYLESSONWINDOWCLOSED=1;				
	}
	else
		$MYLESSONWINDOWCLOSED=0;			
}

genesis_commit($con);
closeDB($con);		
?>
<!doctype html>
<!--[if IE 7 ]>    <html lang="en-gb" class="isie ie7 oldie no-js"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en-gb" class="isie ie8 oldie no-js"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en-gb" class="isie ie9 no-js"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en-gb" class="no-js"> <!--<![endif]-->
<head>
	<title>xtutor.online</title>
	
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="keywords" content="" />
	<meta name="description" content="" />
    
    <!-- Favicon --> 
	<link rel="shortcut icon" href="images/favicon.html">
    
    <!-- this styles only adds some repairs on idevices  -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Google fonts - witch you want to use - (rest you can just remove) -->
   	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic,700,700italic,800,800italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Raleway:100,200,300,400,500,600,700,800,900' rel='stylesheet' type='text/css'>
    
    <!--[if lt IE 9]>
		<script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
    
    <!-- ######### CSS STYLES ######### -->
	
    <link rel="stylesheet" href="css/reset.css" type="text/css" />
	<link rel="stylesheet" href="css/style.css" type="text/css" />
    
    <link rel="stylesheet" href="css/font-awesome/css/font-awesome.min.css">
    
    <!-- responsive devices styles -->
	<link rel="stylesheet" media="screen" href="css/responsive-leyouts.css" type="text/css" />
    
    <!-- animations -->
    <link href="js/animations/css/animations.min.css" rel="stylesheet" type="text/css" media="all" />
    
  
    <!-- style switcher -->
    <link rel = "stylesheet" media = "screen" href = "js/style-switcher/color-switcher.css" />
    
    <!-- mega menu -->
    <link href="js/mainmenu/stickytwo.css" rel="stylesheet">
    <link href="js/mainmenu/bootstrap.min.css" rel="stylesheet">
    <link href="js/mainmenu/demo.css" rel="stylesheet">
    <link href="js/mainmenu/menu.css" rel="stylesheet">
    
    <!-- slide panel -->
    <link rel="stylesheet" type="text/css" href="js/slidepanel/slidepanel.css">
    
	<!-- cubeportfolio -->
	<link rel="stylesheet" type="text/css" href="js/cubeportfolio/cubeportfolio.min.css">
    
	<!-- tabs -->
    <link rel="stylesheet" type="text/css" href="js/tabs/assets/css/responsive-tabs.css">
    <link rel="stylesheet" type="text/css" href="js/tabs/assets/css/responsive-tabs2.css">
    <link rel="stylesheet" type="text/css" href="js/tabs/assets/css/responsive-tabs3.css">

	<!-- carousel -->
    <link rel="stylesheet" href="js/carousel/flexslider.css" type="text/css" media="screen" />
 	<link rel="stylesheet" type="text/css" href="js/carousel/skin.css" />
    
    <!-- progressbar -->
  	<link rel="stylesheet" href="js/progressbar/ui.progress-bar.css">
    
    <!-- accordion -->
    <link rel="stylesheet" href="js/accordion/accordion.css" type="text/css" media="all">
    
    <!-- Lightbox -->
    <link rel="stylesheet" type="text/css" href="js/lightbox/jquery.fancybox.css" media="screen" />
	
    <!-- forms -->
    <link rel="stylesheet" href="js/form/sky-forms.css" type="text/css" media="all">
    
    <link rel="stylesheet" type="text/css" href="xtutor.css">  
    <link rel="stylesheet" type="text/css" href="vendor/jquery-ui/jquery-ui.min.css">  
    <style>
        .ui-datepicker {
            width: 300px; /*what ever width you want*/
        }
    </style>
</head>

<body onload="load()">


<div class="site_wrapper">

<?include("header.htm");?>

<div class="clearfix"></div>

<div class="page_title2">
<div class="container">

    <div class="title"><h1>Lesson</h1></div>
    
    <!--<div class="pagenation">&nbsp;<a href="index.html">Home</a> <i>/</i> <a href="#">Pages</a> <i>/</i> Login Form</div>-->
    
</div>
</div><!-- end page title -->  

<div class="clearfix"></div>

<div class="container">

	<div  class="content_fullwidth">
                <?php if ($STATUS==0):?>
                    <?php  if ($_selected_lesson_type == 0):?>
                        <div style="display: flex;justify-content: center;">
                            <div style="background-color: #111;width:400px;height: 60px;text-align: center;color: white;padding-top: 2px">                        
                                <div id="eatTimer1">
                                    <div style="font-size: 20px;" class="values"></div>
                                    <div style="font-size: 12px;line-height: 12px;padding: 0px 2px" class="progress_bar">.</div>
                                </div>
                            </div>                        
                        </div>
                        <div style="display: flex;justify-content: center;">                    
                            <div style="background-image:url(images/waiting.gif);width:400px;height: 230px;background-size: cover;background-position: 0 -50px"></div> 
                        </div>
                    <?php  else:?> 
                        <div style="display: flex;justify-content: center;">                    
                            <div style="background-image:url(images/waiting.gif);width:400px;height: 280px;background-size: cover;"></div> 
                        </div>
                    <?php  endif;?>                                
                <?php endif;?>
            
            
	  	<div class="sky-form" style="display: flex; justify-content: center;">
                    
		<?php			  		 	  
		if($STATUS==1)
		{
			echo "<div style='width:300px;height:100px;margin-bottom:70px'>";
			echo "<div style='background:$GREEN;color:white;font-weight:bold;width:100%;height:50px;line-height:50px;text-align:center' >We found a tutor for you ! </div>"; 	
		    echo "<div style='width:100%'>";
			echo "<table id='table1' class='header' width=100%><tr><td><output id='timer'>00</output>:<output id='timer2'>00</output></td></tr>";
			echo "<tr><td> <button id='openbutton' class='button' onclick='gotolesson()'>Enter lesson</button></td>";  
			echo "<td><button id='cancelbutton' class='button' onclick='cancel()'>Cancel lesson</button></td>";
			echo "</tr></table></div></div>";
			
		}	
		if($STATUS==2 && $MYLESSONWINDOWCLOSED)  //the student was already in the window but for any reason the window is closed
		{
			echo "<button id='openbutton' class='button' onclick='gotolesson()'>GO BACK TO YOUR LESSON !</button>";
		}
		?>
		</div>
      
		
	<div class="login_form">
		<form id="form1" class="sky-form" method="post" onsubmit="return validateForm(event)" action="lesson.htm" enctype="multipart/form-data">
			<header>Request a lesson:<span id="testTxt"></span></header>
			<fieldset>
			
				<!-- MAE. 08/06/2020.  Se oculta el campo Student level-->				
				<section style="display:none">
						<label class="input">
							<i class="icon-append icon-user"></i>
							<input disabled type="text" id="form_schooltype" name="form_schooltype" placeholder="<? echo $SCHOOLTYPE_LIST[$SCHOOLTYPE];?>">
						</label>
				</section>
				
				<input type="hidden" id="form_lessoncode" name="form_lessoncode" >
					
				<section><strong>Field area
					<label class="select">
						<select id="form_field" name="form_field" onchange="fieldselected()">
							<option value="" selected disabled>Field of study</option>
							<?php
							for ($i=0;$i<4;$i++)
							{
								if($form_field!="" && $form_field==$i)
									echo "<option selected value='$i'>".$FIELDS_LIST[$i]."</option>";
								else
									echo "<option value='$i'>".$FIELDS_LIST[$i]."</option>";
							}					
							?>														
						</select>
						<i></i>
					</label>
				</section>
				
				<section><strong>Subject
					<label class="select">
						<!-- MAE. 09/06/2020, 	se adicional evento onchage para recargar los tutores disponbles
												para el fiels y subject seleccionados.-->
						<select id="form_lessonsubject" name="form_lessonsubject" onchange="fieldselected()">
							<option value="" selected disabled>Subject</option>
							<?php
							for ($i=0;$i<sizeof($SUBJECTS_CODES);$i++)
							{
							   if($form_lessonsubject!="" && $form_lessonsubject==$SUBJECTS_CODES[$i])
								echo "<option selected value='".$SUBJECTS_CODES[$i]."'>".$SUBJECTS_NAMES[$i]."</option>"; 
							   else					   
								echo "<option value='".$SUBJECTS_CODES[$i]."'>".$SUBJECTS_NAMES[$i]."</option>";														
							}   
							?>
						</select>
						<i></i>
					</label>
				</section>
				<section><strong>Lesson type
					<label class="select">
						<select id="form_lessontype" name="form_lessontype" onload="AppJ.onSelectTypeLesson(this)" onchange="AppJ.onSelectTypeLesson(this)">
							<option value="" selected disabled>Type of lesson</option>
							<?php for ($i=0;$i<sizeof($LESSONTYPES_CODES);$i++):?>
								<?php if ($form_lessontype!="" && $form_lessontype==$LESSONTYPES_CODES[$i]):?>
									<option selected value="<?php echo $LESSONTYPES_CODES[$i];?>" data-lesson-type="<?php echo $LESSONTYPES_LESSONTYPE[$i];?>"><?php echo $LESSONTYPES_NAMES[$i]; ?></option>
								<?php else:?>
									<option value="<?php echo $LESSONTYPES_CODES[$i];?>" data-lesson-type="<?php echo $LESSONTYPES_LESSONTYPE[$i];?>"><?php echo $LESSONTYPES_NAMES[$i]; ?></option>
								<?php endif;?>                                                                
							<?php endfor;?>
						</select>
						<i></i>
					</label>
				</section>
				
				<!-- MAE. 08/06/2020.  Campo Tutor agregado
				Req.: Add the “Tutor” dropdown field below the Type of lesson field, this should filter only the available tutors for the selected Field of Study and Subject. The items list should display the tutor’s tariff in format: Tutor name - Rate e.g.  “John Smith - $12 /hour”
				-->
								
				<section><strong>Tutor
					<label class="select">
						<select id="form_availabletutor" name="form_availabletutor"
								onload = "AppJ.getAvailableMinutes(this, <?php echo $USER_BALANCE;?>)"
								onchange = "AppJ.getAvailableMinutes(this, <?php echo $USER_BALANCE;?>)">
							<option value="" selected disabled>Available tutor</option>
							<?php
							for ($i=0;$i<sizeof($TUTORLESSON_USERCODE);$i++)
							{
							   if($form_availabletutor!="" && $form_availabletutor==$TUTORLESSON_USERCODE[$i]){
								echo "<option selected value='".$TUTORLESSON_USERCODE[$i]."'>".$TUTORLESSON_TARIFF[$i]."</option>";
								$tutor_selected_tariff = $TUTORLESSON_TARIFF[$i]; //MAE.13062020 guardamos la tarifa del tutor.
								}
							   else					   
								echo "<option value='".$TUTORLESSON_USERCODE[$i]."'>".$TUTORLESSON_TARIFF[$i]."</option>";
							}   
							?>
						</select>
						<i></i>
					</label>
					<input type="hidden" id="form_tariffturor" name="form_tariffturor">
				</section>
				
				<!-- MAE. 09/06/2020.  Campo Level agregado -->
				<section><strong>Level
					<label class="select">
						<select id="form_level" name="form_level">
							<option value="" selected disabled>Enter Level</option>
							<?
							for ($i=0;$i<2;$i++)
							{
								if($form_level!="" && $form_level==$i)
									echo "<option selected value=$i>".$LEVELSTUDENT_LIST[$i]."</option>";
								else
									echo "<option value=$i>".$LEVELSTUDENT_LIST[$i]."</option>";
							}					
							?>														
						</select>
						<i></i>
					</label>
				</section>
				<!-- MAE. 10/06/2020.  Campo Available minutes agregado -->
				<section><strong>Available minutes for selected tutor
					<label class="input">
						<i class="icon-append icon-time"></i>
						<input 	type="number" name="form_availableminutes" 
								id="form_availableminutes"
								placeholder="Available Minutes" disabled>
						<b class="tooltip tooltip-bottom-right">Available minutes for selected tutor</b>
					</label>
				</section>
				
				<section id="payment_section" style="display:none;">
					<header>Add Credit</header>
					<section><strong>Enter aditional credit
						<label class="input">
							<i class="icon-append icon-money"></i>
							<input 	type="number" name="form_addcredit" min = "1" step="1"
									id="form_addcredit"
									placeholder="Aditional credit"
									>
							<b class="tooltip tooltip-bottom-right">Enter aditional credit</b>
						</label>
					</section>
					<input type="hidden" name="stripeToken" >
					<input type="hidden" id="form_paysection" name="form_paysection" value='<?echo $form_paysection;?>'>
					<div align="center">
						<button id="paybutton" type="submit" name="paybutton" class="button">Add credit</button>
					</div>
				</section>
				
				
				
                                    <?php // if (in_array($_selected_lesson_type, array(1,2,3))):?>
                                    <div id="case1-id" style="display: none">
                                    <section>
                                        <strong>Rate</strong>
					<label class="input">
                                            <i class="icon-append icon-money"></i>
                                            <?php 
                                                $form_rate = $RATE*$LESSON_RATE_FACTOR[$_selected_lesson_type];
                                            ?>
                                            <input readonly="1" type="text" id="form_rate" name="form_rate" placeholder="Rate" value="<?php echo $form_rate?>">
							
					</label>
                                    </section>
                                    <section>
                                        <strong>Attach Document</strong>
					<label class="input">
                                            <input type="file" id="form_attach_document" name="form_attach_document"/>                                            
					</label>
                                    </section>
                                     <section>
                                        <strong>Problem numbers to solve and comments</strong>
					<label class="input">                                            
                                            <textarea rows="3" cols="35" id="form_problem_comments" name="form_problem_comments" placeholder="Problem numbers to solve and comments"></textarea>
					</label>
                                    </section>
                                    <section>
                                        <strong>Estimated time (hours)</strong>
					<label class="select">
                                            <i class="icon-append icon-time"></i>
                                            <select id="form_estimated_time" name="form_estimated_time">
						<option value="" selected disabled>Estimated time (hours)</option>								
						<option value="1">1</option>								
						<option value="1.5">1.5</option>								
						<option value="2">2</option>								
						<option value="2.5">2.5</option>								
						<option value="3">3</option>								
						<option value="3.5">3.5</option>								
						<option value="4">4</option>								
                                            </select>			
					</label>
                                    </section>
                                    <section>
                                        <strong>Due Date</strong>
					<label class="input">
                                            <i class="icon-append icon-calendar"></i>
                                            <input readonly="1" type="text" id="form_due_date" name="form_due_date" placeholder="Due Date">							
					</label>
                                    </section>
                                    </div>    
                                    <?php //endif;?>
                                    <?php //if ($_selected_lesson_type == 2):?>
                                    <div id="case2-id" style="display: none">
                                    <section>
                                        <strong>Availability</strong>
                                        <br><span>&emsp;Option 1:<br>&emsp;Date From To</span>
					<label class="input">
                                            <i class="icon-append icon-calendar"></i>
                                            <input readonly="1" type="text" id="form_availability_option1" name="form_availability_option1">							
					</label>
                                        <span>&emsp;Option 2:<br>&emsp;Date From To</span>
                                        <label class="input">
                                            <i class="icon-append icon-calendar"></i>
                                            <input readonly="1" type="text" id="form_availability_option2" name="form_availability_option2">							
					</label>
                                    </section>
                                    </div>    
                                    <?php //endif;?>
                                    <?php //if (in_array($_selected_lesson_type, array(1,2,3))):?>
                                    <div id="conditions" style="display: none">
                                    <section>					
					<p align=center><b>Conditions</b></p>
                                        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec pharetra ante ut sollicitudin vehicula. Donec suscipit ultricies faucibus. Aenean at fringilla turpis. Vestibulum non tempor neque. Praesent gravida a sem. </p>					
                                    </section>
                                    </div>    
                                    <?php //endif;?>
                                        <input type="hidden" id="form_counter_recorded" name="form_counter_recorded" value="<?php echo $MAXWAITINGTIMEFORSTUDENT?>">
					<input type="hidden" id="form_requestlesson" name="form_requestlesson" value='<?echo $form_requestlesson;?>'>
				</fieldset>
				<footer>
					<div class="sky-form" style="display: flex; justify-content: center;">
                    <button type="submit" id="requestbutton" class="button" >Request lesson</button>
                    </div>
					
				</footer>
			</form>			
		</div>
        
		
	</div>

</div><!-- end content area -->


<?include("footer.htm");?>

</div>

    
<!-- ######### JS FILES ######### -->
<!-- get jQuery from the google apis -->
<script type="text/javascript" src="js/universal/jquery.js"></script>

<!-- style switcher -->
<script src="js/style-switcher/jquery-1.js"></script>
<script src="js/style-switcher/styleselector.js"></script>

<!-- animations -->
<script src="js/animations/js/animations.min.js" type="text/javascript"></script>
<script src="js/animations/js/smoothscroll.js" type="text/javascript"></script>

<!-- slide panel -->
<script type="text/javascript" src="js/slidepanel/slidepanel.js"></script>

<!-- mega menu -->
<script src="js/mainmenu/bootstrap.min.js"></script> 
<script src="js/mainmenu/customeUI.js"></script> 

<!-- jquery jcarousel -->
<script type="text/javascript" src="js/carousel/jquery.jcarousel.min.js"></script>

<!-- scroll up -->
<script src="js/scrolltotop/totop.js" type="text/javascript"></script>

<!-- tabs -->
<script src="js/tabs/assets/js/responsive-tabs.min.js" type="text/javascript"></script>

<!-- jquery jcarousel -->
<script type="text/javascript">
(function($) {
 "use strict";

	jQuery(document).ready(function() {
			jQuery('#mycarouselthree').jcarousel();
                        AppJ.onSelectTypeLesson(document.querySelector("#form_lessontype"));
	});
	
})(jQuery);
</script>

<!-- accordion -->
<script type="text/javascript" src="js/accordion/custom.js"></script>

<!-- sticky menu -->
<script type="text/javascript" src="js/mainmenu/sticky.js"></script>
<script type="text/javascript" src="js/mainmenu/modernizr.custom.75180.js"></script>

<script src="js/form/jquery.form.min.js"></script>
<script src="js/form/jquery.validate.min.js"></script>
<script src="js/form/jquery.modal.js"></script>

<!-- PHP Message -->
<?php 
$message=$_GET['message'];
if($message!="")echo "<script>alert('$message');</script>";  
?>

<script>
var mylessonwindowclosed=<?echo "$MYLESSONWINDOWCLOSED";?>;
var available='<?php echo "$USER_BALANCE"; ?>';
var username='<?php echo "$USER_NAME"; ?>';
var usertype='<?php echo "$USER_TYPE"; ?>';
//document.getElementById("available").innerHTML =available;
//document.getElementById("username").innerHTML =username;

var activelessonstatus=<?php echo "$STATUS"; ?>;   //1st time, user has a lesson currently active, this comes from header, must be at least 0
var activelessoncode='<?php echo "$LESSON_CODEVAR"; ?>';        //1st time, user has a current active lesson, it can not go to another one
var lessonfound=<?php echo "$LESSONFOUND"; ?>;                 //1st time is 0, second time is when this page is reloaded

var _selected_lesson_type = <?php echo $_selected_lesson_type; ?>;

//STUDENTS HAVE A FORM AND SUBMIT THE FORM AND RELOAD THE PAGE
//TUTORS DON'T HAVE THE FORM BUT OPEN LESSONS DIRECTLY
//if the first time there is an active lesson it can not search or go to another lesson


var form_lessoncode='<?php echo "$form_lessoncode" ?>'; //2nd time this variable is not empty and it tryes to go to lesson
var form_lessontype=<?php echo "$form_lessontype" ?>; //2nd time this variable is not empty and it tryes to go to lesson
var form_lessonsubject=<?php echo "$form_lessonsubject" ?>; //2nd time this variable is not empty and it tryes to go to lesson

if(activelessonstatus==1)setInterval(myTimer,1000);  //every sec
setTimeout(reload,<?echo "$RELOAD";?>);

function reload()
{
	location.reload(); 
}

function load()
{
	//var request=document.getElementById("form_requestlesson").value;
	if(activelessonstatus==0 || activelessonstatus==1)
	{
		document.getElementById("form_field").disabled=true;
		document.getElementById("form_lessonsubject").disabled=true;
		document.getElementById("form_lessontype").disabled=true;
		document.getElementById("form_availabletutor").disabled=true;	//MAE. 09/06/2020 agregar tutor
		document.getElementById("form_level").disabled=true;	//MAE. 09/06/2020 agregar level
		document.getElementById("requestbutton").innerHTML="Cancel request";
		document.getElementById("form1").setAttribute('onsubmit','return validateCancel(event)');
		
	}
	else
	{
		document.getElementById("form_field").disabled=false;
		document.getElementById("form_lessonsubject").disabled=false;
		document.getElementById("form_lessontype").disabled=false;
		document.getElementById("form_availabletutor").disabled=false;  //MAE. 09/06/2020 agregar tutor
		document.getElementById("form_level").disabled=false;  //MAE. 09/06/2020 agregar level
		document.getElementById("requestbutton").innerHTML="Request lesson";
		document.getElementById("form1").setAttribute('onsubmit','return validateForm(event)');
	}
	
	//if(lessonfound  && activelessonstatus==1)gotolesson();
}

function sleep(milliseconds) {
  var start = new Date().getTime();
  for (var i = 0; i < 1e7; i++) {
    if ((new Date().getTime() - start) > milliseconds){
      break;
    }
  }
}
if(lessonfound || activelessonstatus)
{
	//change this 
	//document.getElementById("lesson").innerHTML ="Active lesson: "+activelessoncode;	
	//document.getElementById("openbutton").disabled=!mylessonwindowclosed; //if there is an active lesson it depends if the window is closed or not	
}
else
{
	//change this 
	//document.getElementById("lesson").innerHTML ="No active lesson";
    //document.getElementById("openbutton").disabled=false; 	
}




//the form calls the same page to search the lesson
function validateForm(e)
{
  
  if(document.getElementById("form_field").value=='')
  {
	alert('Enter the field of study');
	return false;
  }
  if(document.getElementById("form_lessonsubject").value=='')
  {
	alert('Enter the subject');
	return false;
  }
  if(document.getElementById("form_lessontype").value=='')
  {
	alert('Enter the type of lesson');
	return false;
  }

  if(document.getElementById("form_availabletutor").value=='')	// MAE. 09/06/2020 Agregar valida tutor
  {
	alert('Select a tutor');
	return false;
  }
  if(document.getElementById("form_level").value=='')	// MAE. 09/06/2020 Agregar valida level
  {
	alert('Select a Level');
	return false;
  }
  
  var requiredcredit = parseInt(document.getElementById('form_tariffturor').value);
  if(parseInt(available) < requiredcredit){
		alert('Insuficient Available credit. Please add more credit.');
		return false;
  }
  
  if (document.getElementById("payment_section").style.display != "none")
  {
  
	  if (document.getElementById("form_addcredit").value == ""){
		alert('Insuficient Available credit. Please add more credit.');
		return false;
	  }
	  
	  
	  var availablecredir = parseInt(available) + parseInt(document.getElementById("form_addcredit").value);
		  
	  if(availablecredir < requiredcredit && usertype=='STUDENT')
	  {
		alert('Insuficient Available credit. Please add more credit.');
		document.getElementById("form_paysection").value = "no";
		return false;
	  } else {
		document.getElementById("form_paysection").value = "yes";
	  }
	}
    
   if([1,2,3].indexOf(_selected_lesson_type)>= 0 ){
   
        if(document.getElementById("form_attach_document").value==''){
            alert('Enter the attach document');
            return false;
        }
        
        if(document.getElementById("form_problem_comments").value==''){
            alert('Enter problem numbers to solve and comments');
            return false;
        } 
        
        if(document.getElementById("form_estimated_time").value== ''){
            alert('Enter the estimated time');
            return false;
        } 
        
        if (document.getElementById("form_due_date").value == ''){
            alert('Enter the Due Date');
            return false;
        }
   }
   
   if (_selected_lesson_type == 2){
        
        if (document.getElementById("form_availability_option1").value == ''){
            alert('Enter Avalilability Date Option 1');
            return false;
        }
        
        if (document.getElementById("form_availability_option2").value == ''){
            alert('Enter Avalilability Date Option 2');
            return false;
        }
   }
   
	if (document.getElementById("payment_section").style.display != "none")
	{
		document.getElementById("form_requestlesson").value='yes';
		return true;
	}

}


function validateCancel(e)
{
	document.getElementById("form_requestlesson").value='cancel';
	return true;
} 

function cancel()
{
	document.getElementById("form_requestlesson").value='cancel';
	document.getElementById("form1").submit();
} 

function gotolesson()  
{
   window.open("lessonwindow.htm?code="+activelessoncode, '_blank');
   
}

function fieldselected()
{
	f=document.getElementById("form1");
	//alert(f);
	f.action='lesson.htm';
	f.submit();
}


var deadline=0;
<?if($STATUS==1) echo "deadline=$DEADLINE;";?>
function myTimer() {
    //alert('deadline='+deadline);
    var d = new Date();  //now`
	//alert('d='+d);
	var currentseconds=d.getMinutes()*60+d.getSeconds();
	//alert('currentseconds='+currentseconds);
	var elapsedseconds= deadline-currentseconds;  //elapsed seconds
	//alert('elapsedseconds='+elapsedseconds);
	var displayminutes= Math.floor(elapsedseconds/60).toString();
	var displayseconds=Math.floor(elapsedseconds%60).toString();
	document.getElementById("timer").innerHTML = displayminutes	;
	document.getElementById("timer2").innerHTML =displayseconds;
    if(elapsedseconds==0)cancel();	
}

</script>
<script>
if ( window.history.replaceState ) {
  window.history.replaceState( null, null, "lesson.htm" );
}
</script>



<!-- cubeportfolio -->
<script type="text/javascript" src="js/cubeportfolio/jquery.cubeportfolio.min.js"></script>
<script type="text/javascript" src="js/cubeportfolio/main.js"></script>
<script type="text/javascript" src="js/cubeportfolio/main5.js"></script>
<script type="text/javascript" src="js/cubeportfolio/main6.js"></script>

<!-- carousel -->
<script defer src="js/carousel/jquery.flexslider.js"></script>
<script defer src="js/carousel/custom.js"></script>

<!-- lightbox -->
<script type="text/javascript" src="js/lightbox/jquery.fancybox.js"></script>
<script type="text/javascript" src="js/lightbox/custom.js"></script>


<script type="text/javascript" src="vendor/jquery-ui/jquery-ui.min.js"></script>
<script type="text/javascript" src="vendor/easytimer/easytimer.min.js"></script>


<script type="text/javascript" >
    var AppJ = AppJ || {
        config:{
            rate:<?php echo $RATE;?>
            ,lessonRateFactor:<?php echo json_encode($LESSON_RATE_FACTOR); ?>
            ,MAXWAITINGTIMEFORSTUDENT:<?php echo $MAXWAITINGTIMEFORSTUDENT; ?>
            ,SECONDS_SINCE_REQUEST:<?php echo $SECONDS_SINCE_REQUEST?>
        }                        
    };       
            
    $("#form_due_date").datepicker({dateFormat: 'yy-mm-dd',minDate: new Date(Date.now() + 1*24*60*60*1000)});
    $("#form_availability_option1").datepicker({dateFormat: 'yy-mm-dd',minDate: new Date(Date.now() + 1*24*60*60*1000)});
    $("#form_availability_option2").datepicker({dateFormat: 'yy-mm-dd',minDate: new Date(Date.now() + 1*24*60*60*1000)});
    
    
    
</script>
<script type="text/javascript" src="lesson.js"></script>
</body>
</html>
